<!DOCTYPE html>
<html>
<head>
    <title>SDFBS - Distributed Cloud Storage</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background: #f5f5f5; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .container { background: white; padding: 20px; border-radius: 10px; margin: 20px 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px; }
        button:hover { background: #5a67d8; }
        .file-item, .node-item { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #667eea; }
        .status-healthy { color: #28a745; font-weight: bold; }
        .status-unhealthy { color: #dc3545; font-weight: bold; }
        .stats { display: flex; justify-content: space-around; text-align: center; }
        .stat-item { padding: 10px; }
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        input[type="file"] { margin: 10px 0; padding: 8px; }
        .upload-progress { display: none; margin: 10px 0; }
        .progress-bar { width: 100%; height: 20px; background: #e9ecef; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üîê SDFBS - Secure Distributed File Backup System</h1>
        <p>Phase 1: Cloud Architecture with Distributed Storage</p>
    </div>

    <div class="container">
        <h3>üìä System Overview</h3>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number" id="totalFiles">0</div>
                <div>Total Files</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="activeNodes">0</div>
                <div>Active Nodes</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalStorage">0 MB</div>
                <div>Storage Used</div>
            </div>
        </div>
    </div>

    <div class="grid">
        <div class="container">
            <h3>üì§ Upload File</h3>
            <input type="file" id="fileInput" multiple>
            <button onclick="uploadFile()">Upload to Distributed Storage</button>
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div id="progressText">Uploading...</div>
            </div>
            <div id="uploadStatus"></div>
        </div>

        <div class="container">
            <h3>üñ•Ô∏è Storage Nodes</h3>
            <button onclick="loadNodes()">Refresh Nodes</button>
            <div id="nodesList"></div>
        </div>
    </div>

    <div class="container">
        <h3>üìÅ Distributed Files</h3>
        <button onclick="loadFiles()">Refresh Files</button>
        <div id="filesList"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080';

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select at least one file');
                return;
            }

            const progressDiv = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const statusDiv = document.getElementById('uploadStatus');

            progressDiv.style.display = 'block';
            statusDiv.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    progressText.textContent = `Uploading ${file.name} (${i + 1}/${files.length})...`;
                    progressFill.style.width = `${((i + 1) / files.length) * 100}%`;

                    const response = await fetch(`${API_BASE}/upload`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        statusDiv.innerHTML += `<div style="color: green;">‚úÖ ${file.name} uploaded to ${result.node_id} (${result.chunks} chunks)</div>`;
                    } else {
                        statusDiv.innerHTML += `<div style="color: red;">‚ùå ${file.name}: ${result.error}</div>`;
                    }
                } catch (error) {
                    statusDiv.innerHTML += `<div style="color: red;">‚ùå ${file.name}: ${error.message}</div>`;
                }
            }

            progressDiv.style.display = 'none';
            loadFiles();
            loadNodes();
            updateStats();
        }

        async function loadFiles() {
            try {
                const response = await fetch(`${API_BASE}/files`);
                const files = await response.json();
                
                const filesList = document.getElementById('filesList');
                filesList.innerHTML = files.map(file => `
                    <div class="file-item">
                        <strong>${file.filename}</strong>
                        <div>Size: ${(file.file_size / 1024).toFixed(1)} KB | Node: ${file.node_id}</div>
                        <div>Uploaded: ${new Date(file.upload_time).toLocaleString()}</div>
                        <button onclick="downloadFile('${file.file_id}', '${file.filename}')" 
                                style="float: right; margin-top: 10px;">Download</button>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('filesList').innerHTML = 
                    `<div style="color: red;">‚ùå Error loading files: ${error.message}</div>`;
            }
        }

        async function loadNodes() {
            try {
                const response = await fetch(`${API_BASE}/nodes`);
                const nodes = await response.json();
                
                const nodesList = document.getElementById('nodesList');
                nodesList.innerHTML = nodes.map(node => `
                    <div class="node-item">
                        <strong>Node: ${node.node_id}</strong>
                        <div class="${node.status === 'active' ? 'status-healthy' : 'status-unhealthy'}">
                            Status: ${node.status || 'unknown'}
                        </div>
                        <div>Files: ${node.files_count || 0}</div>
                        <div>Storage: ${((node.storage_used || 0) / 1024 / 1024).toFixed(2)} MB</div>
                        <div>Last Heartbeat: ${node.last_heartbeat ? new Date(node.last_heartbeat).toLocaleString() : 'Never'}</div>
                    </div>
                `).join('');
            } catch (error) {
                document.getElementById('nodesList').innerHTML = 
                    `<div style="color: red;">‚ùå Error loading nodes: ${error.message}</div>`;
            }
        }

        async function updateStats() {
            try {
                const [filesResponse, nodesResponse] = await Promise.all([
                    fetch(`${API_BASE}/files`),
                    fetch(`${API_BASE}/nodes`)
                ]);
                
                const files = await filesResponse.json();
                const nodes = await nodesResponse.json();
                
                document.getElementById('totalFiles').textContent = files.length;
                document.getElementById('activeNodes').textContent = nodes.filter(n => n.status === 'active').length;
                
                const totalStorage = files.reduce((sum, file) => sum + file.file_size, 0);
                document.getElementById('totalStorage').textContent = `${(totalStorage / 1024 / 1024).toFixed(2)} MB`;
                
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        function downloadFile(fileId, filename) {
            window.open(`${API_BASE}/download/${fileId}`, '_blank');
        }

        // Auto-refresh every 30 seconds
        setInterval(() => {
            loadFiles();
            loadNodes();
            updateStats();
        }, 30000);

        // Load initial data
        loadFiles();
        loadNodes();
        updateStats();
    </script>
</body>
</html>